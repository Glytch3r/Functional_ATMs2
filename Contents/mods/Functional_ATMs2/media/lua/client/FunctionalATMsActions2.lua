--[[⠀
----------------------------------------------------------------------------------------------------------------------------⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀                       ⠀⢀⣀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣀⣀⣀⣀⣀⣀⣀⣰⣦⣀⣀⠀⠠⠄⠄⠠⠀⠀⢀⣠⣤⣀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢀⣾⡏⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣠⣶⡿⢿⣦⠀⠀⠀⠀⠀⠀⠀⢀⡷⠀⠀⠀⠀⠀⣀⠀⠀⠀⠀⠀⣩⡿⠋⠙⠉⢩⡿⠟⠀⠀⠀⠀⠀⠀⢀⣶⣾⠟⠋⠛⣿⣷⡄⠀⠀⠀⠀⠀⣴⣿⠂⠀⠀⣼⡿⠀⠀⠀⠀⠀⠀⢀⣠⡴⠶⣤⠀⠀⠀⠀⠀⠀⠀⠀⣠⣴⠦⠤⣤⣤⣀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⢀⣼⡿⠋⠀⢸⠏⠀⠀⠀⠀⠀⠀⠀⣼⠃⠀⠀⠀⠀⢠⡇⠀⠀⠀⢠⣾⠋⠀⠀⠀⠀⣸⠀⠀⠀⠀⠀⠀⠀⢠⣿⠋⠀⠀⠀⠀⠛⠛⠁⠀⠀⠀⢀⣾⣿⠏⠀⠀⢀⡿⠃⠀⠀⠀⠀⠀⠶⠋⠁⢀⣰⠟⠀⠀⠀⠀⠀⠀⠀⣹⣿⠀⠀⠀⠀⣨⣿⠇⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⣾⡟⢀⣠⣤⣴⣶⠆⠀⠀⠀⠀⠀⢰⠃⠀⠀⠀⠀⠀⣾⠀⠀⠀⣰⣿⠃⠀⠀⠀⠀⠀⣿⡀⠀⠀⠀⠀⠀⢀⣿⠃⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣸⣿⠋⠀⠀⢀⡾⠁⠀⠀⠀⠀⠀⠀⠀⣠⣶⣯⣅⡀⠀⠀⠀⠀⠀⠀⠀⣿⡇⢀⣠⠴⠞⠋⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⣸⡟⠀⠛⠉⣠⣾⠃⠀⠀⠀⠀⠀⠀⣼⠀⠀⠀⠀⠀⠀⢿⣤⡴⢺⢻⠃⠀⠀⠀⠀⠀⢸⡿⠁⠀⠀⠀⠀⠀⠀⢿⠀⠀⠀⠀⢀⣤⠀⠀⠀⠀⠀⢀⣿⣇⡤⠤⢤⣾⣤⣄⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠙⢻⡆⠀⠀⠀⠀⠀⣿⣯⠁⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⣿⠃⠀⠀⢀⣼⠇⠀⠀⠀⠀⠀⠀⣰⠏⠀⠀⠀⠀⠀⠀⠀⠀⠀⢂⠇⠀⠀⠀⠀⠀⠀⣾⡅⠀⠀⠀⠀⠀⠀⠀⢸⣧⡀⠀⠀⣼⠇⠀⠀⠀⠀⠀⢸⣿⠀⠀⠀⠐⡇⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣼⠃⠀⠀⠀⠀⠀⢰⡏⠘⣦⠀⠀⠀⠀⡀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠘⢧⣤⡶⠟⢻⠀⠀⠀⠀⠀⠀⢠⡏⠀⠀⠀⠀⠀⠀⠀⠀⠀⢘⠏⠀⠀⠀⠀⠀⠀⢰⣿⡄⠀⠀⠀⠀⠀⠀⠀⠀⠙⠿⣶⡾⠋⠀⠀⠀⠀⠀⠀⢸⡟⠀⠀⠀⢰⠇⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣀⠞⠁⠀⠀⠀⠀⠀⠀⠁⠀⠈⠙⠂⠔⠊⠁⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣼⠀⠀⠀⠀⠀⢀⣿⣤⠶⠒⠒⠁⠀⠀⠀⠀⢠⠏⠀⠀⠀⠀⠀⠀⠀⠀⠈⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠉⠀⠀⠀⠀⢸⠀⠀⠀⠀⠀⠀⠀⠀⠀⠄⠐⠊⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠁⠀⠀⠀⠀⠀⠀⠀⠀⠀⠃⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢀⡿⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀

----------------------------------------------------------------------------------------------------------------------------
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
Please contact me if you need to hire someone to do mods or other design related tasks
https://steamcommunity.com/id/glytch3r/myworkshopfiles/
https://www.glytch3r.com
https://ko-fi.com/glytch3r
Discord: Glytch3r#2892
--special thnx to ChuckGPT for helping me refactor and integrate to atm v2 with his shops and traders mod
----------------------------------------------------------------------------------------------------------------------------
--]]
--require "lua_timers"
require "recipecode"

Recipe = Recipe or {}
Recipe.GetItemTypes = Recipe.GetItemTypes or {}
Recipe.OnCanPerform = Recipe.OnCanPerform or {}
Recipe.OnCreate = Recipe.OnCreate or {}
Recipe.OnGiveXP = Recipe.OnGiveXP or {}
Recipe.OnTest = Recipe.OnTest or {}

FunctionalATMs2 = {}
sellables = {}


function FunctionalATMs2.isShopValid()
    if getActivatedMods():contains("pz-shops-and-traders") and SandboxVars.FATM2.Wallet then
        return true
    else
        return false
    end
end

function FunctionalATMs2.ATMxShops()
if not FunctionalATMs2.isShopValid() then return end
local player = getPlayer()
    if player and not player:getModData()['ATMxShops'] then 
        getOrSetWalletID(player)  -- initiate player wallet
        player:getModData()['ATMxShops'] = true   -- prevent from doing it again next login
    end
end

Events.OnGameStart.Add(FunctionalATMs2.ATMxShops)

Events.OnGameStart.Add(function()
    local oldDestroy = ISDestroyCursor.canDestroy;
    function ISDestroyCursor.canDestroy(self, object)
        -- local atmTiles = {"location_business_bank_01_64", "location_business_bank_01_65", "location_business_bank_01_66", "location_business_bank_01_67"}
        local origReturn = oldDestroy(self, object)
        if origReturn then
            if object:getModData()['atmConverted'] == true and not getPlayer():isAccessLevel('admin')  then
                return false
            else
                return origReturn
            end
        end
    end
end)

---associative array of string-patterns and values
local itemToSellValues = {
    ["sweater"]=0, ["hat"]=0, ["star"]=0, --["hat_goldstar"]=0,
    ["jacket"]=0, ["paint"]=0, ["sock"]=0, ["shirt"]=0, ["pants"]=0,

    ["diamond"]=5,

    ["tag"]=3, ["locket"]=3,

    ["ruby"]=2, ["pearl"]=2, ["sapphire"]=2, ["emerald"]=2, ["amethyst"]=2, ["amber"]=2,

    ["gold"]=1, ["silver"]=1, ["antique"]=1,
}

---You cannot rely on associative arrays' order, so you need a numerically keyed list with matching values
---first load the keys with less-than-or-equal to 0 values as they don't need to be sorted
local itemsNamesSorted = {}
for key, value in pairs(itemToSellValues) do if value <= 0 then table.insert(itemsNamesSorted, key) end end

---secondly, grab the keys with greater-than 0 values, and load them into a new list,
---sort them based on the matching value in the associative array
local itemsNeedSorting = {}
for key, value in pairs(itemToSellValues) do if value > 0 then table.insert(itemsNeedSorting, key) end end
table.sort(itemsNeedSorting, function(a, b) return (itemToSellValues[a] > itemToSellValues[b]) end)
---add the sorted keys (now values) into the list with non-sorted less-than-or-equal to 0
for key, value in pairs(itemsNeedSorting) do table.insert(itemsNamesSorted, value) end
------This creates a list of 0 values first, then highest to lowest after (0,0,0,0,5,4,3,2,1)

function FunctionalATMs2.checkQty(toSell)
    local itemName = string.lower(toSell:getName())
    ---use sorted table with pairs() for consistent order
    --- `name` (value in table) is used as a "key" in the associative array to get matching value there
    for _,name in pairs(itemsNamesSorted) do
        if itemName:contains(name) then
            return itemToSellValues[name]
        end
    end
    return 0
end



function FunctionalATMs2.check(toSell)
    if sellables[toSell] then
        return true
    else
        return false
    end
end
------------------------               ---------------------------
function FunctionalATMs2.getTotalItemsValue(atm)
    local totalSellAmt = 0

    print('-------------------------')
    for i = atm:getItems():size(), 1, -1 do
        local toSell = atm:getItems():get(i - 1);

        local piecePrice = FunctionalATMs2.checkQty(toSell)
        if toSell and piecePrice>0 and not (toSell:isCustomName() and toSell:isCustomName() ~= toSell:getName()) then
            print('Sold ' .. toSell:getName() .. ' for ' .. piecePrice)
            getPlayer():setHaloNote(tostring('Sold ' .. toSell:getName() .. ' for ' .. piecePrice))
            totalSellAmt = totalSellAmt + piecePrice
            if isClient() then atm:removeItemOnServer(toSell); end
            atm:DoRemoveItem(toSell);
            getPlayerLoot(0):refreshBackpacks()
        else
            getPlayerLoot(0):refreshBackpacks()
        end
    end
    return totalSellAmt
end

------------------------               ---------------------------
local function playATMsfx(player)
    getSoundManager():PlayWorldSound('ATMCash', player:getSquare(), 0, 5, 5, false);
    addSound(player, player:getX(), player:getY(), player:getZ(), 5, 1)
end

------------------------               ---------------------------

if FunctionalATMs2.isShopValid() then require "shop-wallet" end


function FunctionalATMs2.ContextMenu(char, context, worldobjects, test)
    local player = getSpecificPlayer(char)
    local atmTiles = {"location_business_bank_01_64", "location_business_bank_01_65", "location_business_bank_01_66",
                      "location_business_bank_01_67"}
    if test and ISWorldObjectContextMenu.Test then
        return true
    end

    local menuCreated = false

    for _, object in ipairs(worldobjects) do
        local square = object:getSquare()
        if square then
            for i = 0, square:getObjects():size() - 1 do
                local obj = square:getObjects():get(i)
                local spr = obj:getSprite():getName()
                if spr == atmTiles[1] or spr == atmTiles[2] or spr == atmTiles[3] or spr == atmTiles[4] then
                    if not menuCreated then
                        if not instanceof(obj, "IsoThumpable") and not obj:getModData()['atmConverted']  and
                            not obj:getContainer() and player:isAccessLevel('admin') then

                            context:addOption("Admin: Activate ATM", spr, (function()
                                sledgeDestroy(obj)
                                obj:getSquare():transmitRemoveItemFromSquare(obj)
                                --[[
                                if isClient() then
                                    obj:transmitCompleteItemToServer();
                                    obj:transmitUpdatedSpriteToClients()
                                end
                                ]]
                                obj = IsoThumpable.new(getCell(), square, spr, false, ISWoodenContainer:new(spr, nil))
                                obj:setSprite(spr)
                                obj:getSprite():setName(spr)
                                obj:setIsThumpable(true)
                                obj:setIsContainer(true)
                                obj:setCanPassThrough(false)
                                obj:setIsDismantable(false)
                                obj:setBlockAllTheSquare(true)
                                -- obj:createContainersFromSpriteProperties()
                                obj:getContainer():setType('atm2')
                                obj:getContainer():setDrawDirty(true)
                                obj:getModData()['atmConverted'] = true
                                -- obj:AddItem('Base.Apple')
                                square:AddTileObject(obj);
                                if isClient() then
                                    obj:transmitCompleteItemToServer();
                                    obj:transmitUpdatedSpriteToClients()
                                end
                                getPlayerLoot(0):refreshBackpacks()
                            end))
                        elseif instanceof(obj, "IsoThumpable") and obj:getModData()['atmConverted'] == true then
                            if SandboxVars.FATM2.Item then
                                context:addOption("ATM2: Sell for Cash item ", spr, (function()
                                    local totalSellAmt = FunctionalATMs2.getTotalItemsValue(obj:getContainer())
                                    totalSellAmt = math.floor(totalSellAmt)
                                    if totalSellAmt == 0 then
                                        player:setHaloNote('Nothing to sell', 255, 50, 50, 100)
                                    else
                                        if FunctionalATMs2.isShopValid() then
                                            local money = InventoryItemFactory.CreateItem('Base.Money')
                                            if money then
                                                generateMoneyValue(money, totalSellAmt)
                                                player:getInventory():AddItem(money)
                                            end
                                        else
                                            player:getInventory():AddItems('Base.Money', totalSellAmt)
                                        end
                                        player:setHaloNote('Recieved: $' .. totalSellAmt)
                                    end
                                    getPlayerLoot(0):refreshBackpacks()
                                    obj:getContainer():setDrawDirty(true);
                                    --ISInventoryPane:refreshContainer()
                                    playATMsfx(player)
                                end))
                            end
                            if getActivatedMods():contains("pz-shops-and-traders") and SandboxVars.FATM2.Wallet then
                                context:addOption("ATM2: Sell Direct to wallet", spr, (function()
                                    local totalSellAmt = FunctionalATMs2.getTotalItemsValue(obj:getContainer())
                                    totalSellAmt = math.floor(totalSellAmt)
                                    sendClientCommand("shop", "transferFunds", {
                                        giver = nil,
                                        give = totalSellAmt,
                                        receiver = player:getModData().wallet_UUID,
                                        receive = nil
                                    })
                                    if totalSellAmt == 0 then
                                        player:setHaloNote('Nothing to sell', 255, 50, 50, 100)
                                    else
                                    --initiates wallet if it hasnt been initiated yet for some reason
                                    if player and not player:getModData()['ATMxShops'] then getOrSetWalletID(player) end 
                                        player:setHaloNote('Recieved: $' .. totalSellAmt)
                                    end
                                    getPlayerLoot(0):refreshBackpacks()
                                    obj:getContainer():setDrawDirty(true);
                                    playATMsfx(player)
                                    --ISInventoryPane:refreshContainer()
                                end))
                            end
                        end
                    end
                    menuCreated = true
                end
            end
        end
    end
end

Events.OnFillWorldObjectContextMenu.Add(FunctionalATMs2.ContextMenu)



